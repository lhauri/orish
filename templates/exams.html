{% extends 'base.html' %}
{% block title %}Exams • Orish{% endblock %}
{% block content %}
<div class="card">
    <div class="card-head">
        <div>
            <p class="tag">Active exams</p>
            <h2>Ready when you are</h2>
            <p class="muted">Full-length attempts are shared with teachers so they can review strengths and gaps.</p>
        </div>
        <div class="instructions-card inline">
            <p class="eyebrow">Steps</p>
            <ol class="instruction-steps">
                <li>Choose <strong>Study mode</strong> for unlimited practice.</li>
                <li>Pick <strong>Test mode</strong> for graded attempts sent to teachers.</li>
                <li>Teachers can manage sharing via the buttons below each card.</li>
            </ol>
        </div>
    </div>
    {% if exams %}
    <div class="exam-grid">
        {% for exam in exams %}
        <div class="exam-card">
            <p class="tag">{{ exam.category_label }}</p>
            <h3>{{ exam.title }}</h3>
            <p>{{ exam.description or 'Focused practice with auto-tracking.' }}</p>
            <p class="muted tiny">{{ exam.questions }} question goal • {{ exam.specific_questions }} custom / {{ exam.general_questions }} bank</p>
            {% if exam.has_questions %}
            <div class="exam-actions">
                {% set study_allowed = exam.study_enabled and exam.can_study and exam.has_questions %}
                {% set test_allowed = exam.test_enabled and exam.can_test and exam.has_questions %}
                <a class="btn ghost {% if not study_allowed %}disabled{% endif %}" {% if study_allowed %}href="{{ url_for('take_exam', exam_id=exam.id, mode='study') }}"{% else %}aria-disabled="true"{% endif %}>Study mode</a>
                <a class="btn primary {% if not test_allowed %}disabled{% endif %}" {% if test_allowed %}href="{{ url_for('take_exam', exam_id=exam.id, mode='test') }}"{% else %}aria-disabled="true"{% endif %}>Test mode</a>
            </div>
            {% else %}
            <p class="muted tiny">Needs {{ exam.missing_questions }} more question{{ 's' if exam.missing_questions != 1 else '' }} before students can open it.</p>
            {% if g.user['is_admin'] %}
            <a class="btn ghost" href="{{ url_for('admin_questions', category=exam.category) }}">Restock bank</a>
            {% endif %}
            {% endif %}
            {% if g.user['is_admin'] %}
            <div class="admin-note">
                <p class="tiny">{{ exam.assigned_count }} student{{ 's' if exam.assigned_count != 1 else '' }} currently assigned.</p>
                <div class="admin-actions">
                    <a class="btn secondary" href="{{ url_for('manage_exam', exam_id=exam.id) }}">Manage</a>
                    <a class="btn ghost" href="{{ url_for('admin_questions', category=exam.category) }}">Question bank</a>
                </div>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <p>No exams to show yet.</p>
        <p class="muted">Once a teacher assigns you an exam, it will appear here.</p>
    </div>
    {% endif %}
</div>
<div class="card">
    <h3>Your latest attempts</h3>
    <div class="table-scroll">
        <table class="attempt-table">
            <thead>
                <tr>
                    <th>Exam</th>
                    <th>Mode</th>
                    <th>Date</th>
                    <th>Score</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for attempt in attempts %}
                <tr>
                    <td>{{ attempt.title }}</td>
                    <td>{{ attempt.mode|title }}</td>
                    <td>{{ attempt.created_at }}</td>
                    <td>{{ attempt.score }} / {{ attempt.total }}</td>
                    <td><a class="btn ghost" href="{{ url_for('exam_result', attempt_id=attempt.id) }}">Open</a></td>
                </tr>
                {% else %}
                <tr><td colspan="5">No attempts yet.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% if g.user['is_admin'] %}
<div class="card">
    <h3>Build or generate exams</h3>
    <div class="exam-form-row">
        <form class="exam-form-card" method="post" action="{{ url_for('create_exam') }}">
            <p class="eyebrow">Manual setup</p>
            <label>Title<input name="title" required placeholder="e.g. Business vocab check"></label>
            <label>Description<textarea name="description" rows="2" placeholder="Shown to students"></textarea></label>
            <label>Category
                <select name="category">
                    {% for key, meta in categories.items() %}
                    <option value="{{ key }}">{{ meta.label }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>Question count<input type="number" name="questions" value="5" min="3" max="15"></label>
            <label class="toggle">
                <input type="checkbox" name="study_enabled" checked> <span>Allow study attempts</span>
            </label>
            <label class="toggle">
                <input type="checkbox" name="test_enabled" checked> <span>Allow test attempts</span>
            </label>
            <button class="btn primary">Publish</button>
        </form>
        <form class="exam-form-card" method="post" action="{{ url_for('generate_exam_ai') }}">
            <p class="eyebrow">AI co-creator</p>
            <label>Prompt<textarea name="prompt" rows="5" placeholder="Describe the skill, level, and tone. e.g. 'Create a B1 grammar drill on conditional sentences.'"></textarea></label>
            <button class="btn secondary">Generate draft</button>
        </form>
    </div>
</div>
{% endif %}
{% endblock %}
