{% extends 'base.html' %}
{% block title %}Exams • Orish{% endblock %}
{% block content %}
<section class="exam-hero">
    <div class="card hero-panel">
        <div>
            <p class="tag">Active exams</p>
            <h1>Choose your challenge</h1>
            <p class="muted">Pick study mode for a stress-free run-through or switch to test mode when you want your teacher to review the results.</p>
        </div>
        <div class="hero-stats">
            <article>
                <p class="eyebrow">Study mode</p>
                <p class="stat">Unlimited</p>
                <small>No reporting, just practice.</small>
            </article>
            <article>
                <p class="eyebrow">Test mode</p>
                <p class="stat">Teacher review</p>
                <small>Full analytics sent to your coach.</small>
            </article>
            <article>
                <p class="eyebrow">Track progress</p>
                <p class="stat">{{ attempts|length }}</p>
                <small>Last 10 attempts saved below.</small>
            </article>
        </div>
    </div>
    <div class="card hero-steps">
        <p class="eyebrow">How to use exams</p>
        <ol class="instruction-steps">
            <li>Preview the exam card to see how many custom or banked questions it contains.</li>
            <li>Click <strong>Study</strong> or <strong>Test</strong>; study attempts stay private, test attempts notify teachers.</li>
            <li>Teachers can open the <strong>Manage</strong> panel to share or tweak the question set.</li>
        </ol>
    </div>
</section>
<div class="card surface">
    {% if exams %}
    <div class="exam-grid enhanced">
        {% for exam in exams %}
        {% set study_allowed = exam.study_enabled and exam.can_study and exam.has_questions %}
        {% set test_allowed = exam.test_enabled and exam.can_test and exam.has_questions %}
        <article class="exam-card">
            <div class="exam-card-main">
                <header>
                    <div class="exam-header-row">
                        <span class="tag">{{ exam.category_label }}</span>
                        <div class="mode-pills">
                            {% if exam.study_enabled %}<span class="pill">Study</span>{% endif %}
                            {% if exam.test_enabled %}<span class="pill secondary">Test</span>{% endif %}
                        </div>
                    </div>
                    <div>
                        <h3>{{ exam.title }}</h3>
                        <p>{{ exam.description or 'Focused practice with auto-tracking.' }}</p>
                    </div>
                </header>
                <div class="exam-meta">
                    <p class="muted tiny">{{ exam.questions }} question goal</p>
                    <p class="muted tiny">{{ exam.specific_questions }} custom • {{ exam.general_questions }} bank</p>
                </div>
                {% if g.user['is_admin'] %}
                <p class="muted tiny assigned-pill">Assigned to {{ exam.assigned_count }} student{{ 's' if exam.assigned_count != 1 else '' }}</p>
                {% endif %}
                {% if exam.has_questions %}
                <p class="status-note ready">Ready for students</p>
                {% else %}
                <div class="status-note warning">
                    <p>Needs {{ exam.missing_questions }} more question{{ 's' if exam.missing_questions != 1 else '' }} before opening.</p>
                    {% if g.user['is_admin'] %}
                    <a class="btn ghost restock-btn" href="{{ url_for('admin_questions', category=exam.category) }}">Restock bank</a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            <div class="exam-card-footer">
                <div class="exam-action-grid">
                    <a class="btn action {% if not study_allowed %}disabled{% endif %}"
                        {% if study_allowed %}href="{{ url_for('take_exam', exam_id=exam.id, mode='study') }}"
                        {% else %}aria-disabled="true"{% endif %}>Study mode</a>
                    <a class="btn action primary {% if not test_allowed %}disabled{% endif %}"
                        {% if test_allowed %}href="{{ url_for('take_exam', exam_id=exam.id, mode='test') }}"
                        {% else %}aria-disabled="true"{% endif %}>Test mode</a>
                    {% if g.user['is_admin'] %}
                    <a class="btn action outline"
                        href="{{ url_for('manage_exam', exam_id=exam.id) }}">Manage exam</a>
                    <a class="btn action outline"
                        href="{{ url_for('admin_questions', category=exam.category) }}">Question bank</a>
                    {% endif %}
                </div>
            </div>
        </article>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <p>No exams to show yet.</p>
        <p class="muted">Once a teacher assigns you an exam, it will appear here.</p>
    </div>
    {% endif %}
</div>
<div class="card">
    <h3>Your latest attempts</h3>
    <div class="table-scroll">
        <table class="attempt-table">
            <thead>
                <tr>
                    <th>Exam</th>
                    <th>Mode</th>
                    <th>Date</th>
                    <th>Score</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for attempt in attempts %}
                <tr>
                    <td>{{ attempt.title }}</td>
                    <td>{{ attempt.mode|title }}</td>
                    <td>{{ attempt.created_at }}</td>
                    <td>{{ attempt.score }} / {{ attempt.total }}</td>
                    <td><a class="btn ghost" href="{{ url_for('exam_result', attempt_id=attempt.id) }}">Open</a></td>
                </tr>
                {% else %}
                <tr><td colspan="5">No attempts yet.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% if g.user['is_admin'] %}
<div class="card">
    <div class="card-head">
        <div>
            <p class="eyebrow">Need a new assessment?</p>
            <h3>Open the exam builder</h3>
            <p class="muted">Decide between manual setup or the AI co-creator on the next screen. Drafts stay private until you publish.</p>
        </div>
        <a class="btn primary" href="{{ url_for('new_exam') }}">Create new exam</a>
    </div>
</div>
{% endif %}
{% endblock %}
