<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Orish{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="icon" href="/static/favicon.png">
</head>
<body class="layout">
    <div class="surface-veil" aria-hidden="true"></div>
    <header class="top-bar">
        <div class="brand">
            <a class="logo" href="{{ url_for('home') }}">
                <span class="logo-mark">Orish</span>
                <span class="logo-subtitle">English Skills Studio</span>
            </a>
            {% if g.user %}
            <span class="role-pill" data-role="{{ 'teacher' if g.user['is_admin'] else 'student' }}">
                <i data-lucide="{{ 'graduation-cap' if g.user['is_admin'] else 'user-round' }}"></i>
                <span>{{ 'Teacher' if g.user['is_admin'] else 'Student' }} account</span>
            </span>
            {% endif %}
        </div>
        <div class="nav-area">
            <button class="menu-toggle" aria-label="Toggle navigation" aria-expanded="false" aria-controls="primary-nav">
                <i data-lucide="menu"></i>
            </button>
            <nav id="primary-nav" class="nav-links" data-open="false">
                {% set endpoint = request.endpoint or '' %}
                {% set view_args = request.view_args or {} %}
                {% set active_category = view_args.get('category') if view_args else '' %}
                {% set practice_active = endpoint in ['quiz', 'quiz_select', 'study_packs', 'study_group'] %}
                {% set exam_active = endpoint in [
                    'exams', 'take_exam', 'exam_result', 'manage_exam',
                    'update_exam_settings', 'add_exam_question', 'add_exam_questions_ai',
                    'assign_exam_to_student', 'delete_exam_assignment'
                ] %}
                {% set admin_menu_active = endpoint in [
                    'admin_questions', 'admin_users', 'admin_exam_attempts',
                    'create_question_group', 'assign_question_to_group',
                    'remove_question_from_group', 'share_question_group',
                    'revoke_question_group_assignment'
                ] %}
                <a href="{{ url_for('home') }}" class="nav-item" data-active="{{ 'true' if endpoint == 'home' else 'false' }}">
                    <i data-lucide="home"></i>
                    <span>Home</span>
                </a>
                {% if g.user %}
                <a href="{{ url_for('dashboard') }}" class="nav-item" data-active="{{ 'true' if endpoint in ['dashboard', 'results'] else 'false' }}">
                    <i data-lucide="activity"></i>
                    <span>Dashboard</span>
                </a>
                <div class="nav-dropdown" data-open="false">
                    <button type="button" class="nav-item dropdown-trigger" aria-haspopup="true" aria-expanded="false" aria-controls="practice-menu" data-active="{{ 'true' if practice_active else 'false' }}">
                        <i data-lucide="sparkles"></i>
                        <span>Practice</span>
                        <i data-lucide="chevron-down" class="chevron"></i>
                    </button>
                    <div class="dropdown-panel" id="practice-menu" role="menu">
                        <a href="{{ url_for('quiz', category='vocabulary') }}" class="dropdown-item" data-active="{{ 'true' if endpoint == 'quiz' and active_category == 'vocabulary' else 'false' }}">
                            <i data-lucide="type"></i>
                            <span>Vocabulary</span>
                        </a>
                        <a href="{{ url_for('quiz', category='grammar') }}" class="dropdown-item" data-active="{{ 'true' if endpoint == 'quiz' and active_category == 'grammar' else 'false' }}">
                            <i data-lucide="book"></i>
                            <span>Grammar</span>
                        </a>
                        <a href="{{ url_for('quiz', category='translation') }}" class="dropdown-item" data-active="{{ 'true' if endpoint == 'quiz' and active_category == 'translation' else 'false' }}">
                            <i data-lucide="languages"></i>
                            <span>Translation</span>
                        </a>
                        <a href="{{ url_for('study_packs') }}" class="dropdown-item" data-active="{{ 'true' if endpoint in ['study_packs', 'study_group'] else 'false' }}">
                            <i data-lucide="layers"></i>
                            <span>Study packs</span>
                        </a>
                    </div>
                </div>
                <a href="{{ url_for('exams') }}" class="nav-item" data-active="{{ 'true' if exam_active else 'false' }}">
                    <i data-lucide="trophy"></i>
                    <span>Exams</span>
                </a>
                {% if g.user['is_admin'] %}
                <div class="nav-dropdown" data-open="false">
                    <button type="button" class="nav-item dropdown-trigger" aria-haspopup="true" aria-expanded="false" aria-controls="teacher-menu" data-active="{{ 'true' if admin_menu_active else 'false' }}">
                        <i data-lucide="layout-dashboard"></i>
                        <span>Teacher</span>
                        <i data-lucide="chevron-down" class="chevron"></i>
                    </button>
                    <div class="dropdown-panel" id="teacher-menu" role="menu">
                        <a href="{{ url_for('admin_questions') }}" class="dropdown-item" data-active="{{ 'true' if endpoint == 'admin_questions' else 'false' }}">
                            <i data-lucide="library"></i>
                            <span>Question bank</span>
                        </a>
                        <a href="{{ url_for('admin_exam_attempts') }}" class="dropdown-item" data-active="{{ 'true' if endpoint == 'admin_exam_attempts' else 'false' }}">
                            <i data-lucide="monitor-smartphone"></i>
                            <span>Exam attempts</span>
                        </a>
                        <a href="{{ url_for('admin_users') }}" class="dropdown-item" data-active="{{ 'true' if endpoint == 'admin_users' else 'false' }}">
                            <i data-lucide="users"></i>
                            <span>Manage users</span>
                        </a>
                    </div>
                </div>
                {% endif %}
                <a href="{{ url_for('profile') }}" class="nav-item" data-active="{{ 'true' if endpoint == 'profile' else 'false' }}">
                    <i data-lucide="user"></i>
                    <span>Profile</span>
                </a>
                <a href="{{ url_for('logout') }}" class="nav-item">
                    <i data-lucide="log-out"></i>
                    <span>Logout</span>
                </a>
                {% else %}
                <a href="{{ url_for('login') }}" class="nav-item pill">
                    <i data-lucide="log-in"></i>
                    <span>Login</span>
                </a>
                <a href="{{ url_for('register') }}" class="nav-item accent">
                    <i data-lucide="user-plus"></i>
                    <span>Join</span>
                </a>
                {% endif %}
            </nav>
        </div>
    </header>

    <main class="content">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="flash-container">
            {% for category, message in messages %}
            <div class="flash flash-{{ category }}">{{ message }}</div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}
        {% block content %}{% endblock %}
    </main>

    <footer class="footer">
        <div class="footer-grid">
            <div class="footer-column">
                <p class="logo-mark">Orish</p>
                <p class="footer-text">Short daily practice powered by AI feedback and teacher-friendly analytics.</p>
                <p class="footer-meta">© {{ current_year or 2024 }} Orish • Built for GIBB learners</p>
                <p class="footer-meta git-meta">
                    <span class="git-pill">Branch: {{ git_branch }}</span>
                    <span class="git-pill">Commit: {{ git_commit_short }}</span>
                </p>
            </div>
            <div class="footer-column">
                <p class="footer-heading">Explore</p>
                <a href="{{ url_for('home') }}">Startseite</a>
                <a href="{{ url_for('dashboard') if g.user else url_for('register') }}">
                    {{ 'Dashboard' if g.user else 'Sign up' }}
                </a>
                <a href="{{ url_for('quiz', category='vocabulary') }}">Vocabulary</a>
                <a href="{{ url_for('quiz', category='grammar') }}">Grammar</a>
            </div>
            <div class="footer-column">
                <p class="footer-heading">Legal</p>
                <a href="{{ url_for('legal') }}#terms">Terms of Service</a>
                <a href="{{ url_for('legal') }}#privacy">Privacy Policy</a>
                <a href="{{ url_for('legal') }}#contact">Contact</a>
            </div>
        </div>
    </footer>

    {% if g.user %}
    <div class="ai-widget" data-open="false">
        <button type="button" class="ai-launcher" aria-expanded="false" aria-controls="ai-panel">
            <i data-lucide="bot"></i>
            <span>General purpose AI</span>
        </button>
        <section id="ai-panel" class="ai-panel" data-open="false" aria-hidden="true">
            <header class="ai-panel-header">
                <div>
                    <p class="ai-panel-title">Ask Orish AI</p>
                    <p class="ai-panel-subtitle">Search the web, manage content, or jump to any page.</p>
                </div>
                <button type="button" class="ai-panel-close" aria-label="Close assistant">
                    <i data-lucide="x"></i>
                </button>
            </header>
            <div class="ai-messages" data-role="messages"></div>
            <div class="ai-status" data-role="status" aria-live="polite"></div>
            <form class="ai-form" data-role="form" data-enter-submit="true">
                {{ csrf_field() }}
                <label class="sr-only" for="ai-input">Ask the AI</label>
                <textarea id="ai-input" name="message" rows="2" placeholder="Ask about exams, pages, or create new questions…" required></textarea>
                <div class="ai-form-actions">
                    <button type="submit" class="btn accent">
                        <i data-lucide="send"></i>
                        <span>Send</span>
                    </button>
                </div>
            </form>
        </section>
    </div>
    {% endif %}

    <script>
        window.ORISH = window.ORISH || {};
        window.ORISH.csrfToken = "{{ csrf_token() }}";
        window.ORISH.aiNavTargets = {{ ai_nav_targets|tojson }};
    </script>
    <script src="{{ url_for('static', filename='js/app.js') }}" defer></script>
</body>
</html>
