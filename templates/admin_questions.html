{% extends 'base.html' %}
{% block title %}Admin • Orish{% endblock %}
{% block content %}
<div class="card admin">
    <div class="admin-header">
        <h2>Question bank</h2>
        <form method="get">
            <label>
                Category
                <select name="category" onchange="this.form.submit()">
                    {% for key, meta in categories.items() %}
                    <option value="{{ key }}" {% if key == category %}selected{% endif %}>{{ meta.label }}</option>
                    {% endfor %}
                </select>
            </label>
        </form>
    </div>

    <div class="admin-body">
        <section class="admin-form">
            <h3>AI generate {{ categories[category].label }} questions</h3>
            <form method="post" action="{{ url_for('generate_question_ai', category=category) }}">
                {{ csrf_field() }}
                <label>Prompt<textarea name="prompt" rows="3" placeholder="e.g. Focus on travel vocabulary, B1 level."></textarea></label>
                <button class="btn secondary">Generate via AI</button>
            </form>
        </section>
        <section class="admin-form">
            <h3>Add new {{ categories[category].label }} question</h3>
            <form method="post" action="{{ url_for('add_question', category=category) }}">
                {{ csrf_field() }}
                {% if category == 'vocabulary' %}
                <label>Word<input name="word" required></label>
                {% elif category == 'grammar' %}
                <label>Sentence (use __ for blank)<textarea name="sentence" required></textarea></label>
                {% else %}
                <label>Prompt<textarea name="prompt" rows="4" required></textarea></label>
                <label>Reference answer<textarea name="reference_answer" rows="3" required></textarea></label>
                {% endif %}
                {% if category != 'translation' %}
                <label>Correct answer<input name="correct_answer" required></label>
                <label>Wrong option 1<input name="wrong1" required></label>
                <label>Wrong option 2<input name="wrong2" required></label>
                <label>Wrong option 3<input name="wrong3" required></label>
                {% endif %}
                <button class="btn primary">Save question</button>
            </form>
        </section>
        <section class="info-callout">
            <h4>How grouping works</h4>
            <p>1) Create a study pack below • 2) Attach questions using the controls on each card • 3) Share packs with students so they can practise curated topics.</p>
        </section>
        <section class="admin-list question-bank-list">
            <h3>Existing questions ({{ rows|length }})</h3>
            <ul class="question-list">
                {% for row in rows %}
                <li class="question-card">
                    <div class="question-main">
                        <div>
                            {% if category == 'vocabulary' %}
                            <p class="question-title">{{ row['word'] }}</p>
                            {% elif category == 'grammar' %}
                            <p class="question-title">{{ row['sentence_with_placeholder'] }}</p>
                            {% else %}
                            <p class="question-title">{{ row['prompt']|truncate(60, True) }}</p>
                            <p class="muted tiny">Ref: {{ row['reference_answer']|truncate(80, True) }}</p>
                            {% endif %}
                        </div>
                        <div class="question-actions">
                            <a class="btn ghost" href="{{ url_for('edit_question', category=category, question_id=row['id']) }}">Edit</a>
                            <form method="post" action="{{ url_for('delete_question', category=category, question_id=row['id']) }}" onsubmit="return confirm('Delete question?')">
                                {{ csrf_field() }}
                                <button class="btn danger">Delete</button>
                            </form>
                        </div>
                    </div>
                    <div class="group-meta">
                        {% set attached = memberships.get(row['id'], []) %}
                        {% if attached %}
                        <p class="muted tiny">Groups</p>
                        <div class="group-chips">
                            {% for item in attached %}
                            <span class="chip">{{ item.name }}</span>
                            <form method="post" action="{{ url_for('remove_question_from_group', category=category) }}" class="inline-form">
                                {{ csrf_field() }}
                                <input type="hidden" name="question_id" value="{{ row['id'] }}">
                                <input type="hidden" name="group_id" value="{{ item.group_id }}">
                                <button class="btn ghost tiny" type="submit">Remove</button>
                            </form>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="muted tiny">Not part of any group.</p>
                        {% endif %}
                        {% if groups %}
                        <form class="inline-form select-form" method="post" action="{{ url_for('assign_question_to_group', category=category) }}">
                            {{ csrf_field() }}
                            <input type="hidden" name="question_id" value="{{ row['id'] }}">
                            <label class="sr-only" for="group-select-{{ row['id'] }}">Group</label>
                            <select id="group-select-{{ row['id'] }}" name="group_id">
                                {% for group in groups %}
                                <option value="{{ group.id }}">{{ group.name }}</option>
                                {% endfor %}
                            </select>
                            <button class="btn ghost tiny">Add to group</button>
                        </form>
                        {% endif %}
                    </div>
                </li>
                {% else %}
                <li>No questions yet.</li>
                {% endfor %}
            </ul>
        </section>
        <section class="admin-form">
            <h3>Create a study pack ({{ categories[category].label }})</h3>
            <form method="post" action="{{ url_for('create_question_group', category=category) }}">
                {{ csrf_field() }}
                <label>Name<input name="name" required></label>
                <label>Description<textarea name="description" rows="2"></textarea></label>
                <label>Optional AI prompt<textarea name="ai_prompt" rows="2" placeholder="Why this group exists?"></textarea></label>
                <button class="btn primary">Create group</button>
            </form>
        </section>
        <section class="admin-list">
            <h3>Groups for {{ categories[category].label }} ({{ groups|length }})</h3>
            <ul>
                {% for group in groups %}
                <li>
                    <div>
                        <strong>{{ group.name }}</strong>
                        <p class="muted">{{ group.description or 'No description yet.' }}</p>
                        <p class="tiny">{{ group.question_count }} question{{ 's' if group.question_count != 1 else '' }} • {{ group.student_count }} student{{ 's' if group.student_count != 1 else '' }}</p>
                    </div>
                    <div class="admin-actions stacked">
                        <form method="post" action="{{ url_for('share_question_group', group_id=group.id) }}">
                            {{ csrf_field() }}
                            <input type="hidden" name="category" value="{{ category }}">
                            <label>Share with
                                <input name="identifier" placeholder="student email">
                            </label>
                            <button class="btn secondary">Share</button>
                        </form>
                    </div>
                    {% set assigned = group_assignments.get(group.id, []) %}
                    <div class="assignment-list">
                        {% if assigned %}
                        <ul>
                            {% for assignment in assigned %}
                            <li>
                                {{ assignment.username }} ({{ assignment.email }})
                                <form method="post" action="{{ url_for('revoke_question_group_assignment', group_id=group.id, assignment_id=assignment.id) }}">
                                    {{ csrf_field() }}
                                    <input type="hidden" name="category" value="{{ category }}">
                                    <button class="btn tiny">Remove</button>
                                </form>
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <p class="muted tiny">Not shared with any students yet.</p>
                        {% endif %}
                    </div>
                </li>
                {% else %}
                <li>No groups for this subject yet. Create one above to bundle related questions.</li>
                {% endfor %}
            </ul>
        </section>
    </div>
</div>
{% endblock %}
